<ol class="flex font-semibold text-primary dark:text-white-dark">
    <li class="bg-[#ebedf2] ltr:rounded-l-md rtl:rounded-r-md dark:bg-[#1b2e4b]">
        <a routerLink="/dashboard"
            class="relative flex h-full items-center p-1.5 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-3 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-3 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70">Home</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180">Periodic
            Service</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a routerLink="/requestedPartsPrice"
            class="relative flex h-full items-center p-1.5 px-3 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-6 ltr:before:-right-[15px] rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70">
            Requested Parts Price</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180">Periodic
            Price Details</a>
    </li>
</ol>

<!-- LOADING SHIMMER -->
<div *ngIf="isLoading" class="shimmer-container">
    <!-- Heading shimmer -->
    <div class="shimmer-box mb-4 h-8 w-1/3"></div>
    <div class="shimmer-box mb-6 h-4 w-1/4"></div>

    <!-- Cards shimmer -->
    <div class="mb-6 grid grid-cols-3 gap-4">
        <div class="shimmer-box h-24 rounded-xl"></div>
        <div class="shimmer-box h-24 rounded-xl"></div>
        <div class="shimmer-box h-24 rounded-xl"></div>
    </div>

    <!-- Table shimmer -->
    <div *ngFor="let i of [1, 2, 3, 4, 5]" class="shimmer-box mb-3 h-12 rounded-md"></div>
</div>

<div *ngIf="!isLoading">
    <div class="heading-card mt-4">
        <div class="left">
            <h2 class="title mb-1" style="font-size: 20px; font-weight: 700; color: #ffffff">
                {{ part.spim_name }}
            </h2>

            <div class="tags">
                <span class="part-number gap-2">{{ part.pm_code }}</span>&nbsp;
                <span class="brand">{{ part.brand_name }}</span>
            </div>
            <p>
                Requested by
                <strong>{{ getRequestedBy(part.pm_price_requested_by) }}</strong>
            </p>
        </div>

        <div class="right">
            <p class="label">Price Change</p>

            <p class="font-bold">AED {{ part.pm_price }} ‚Üí AED {{ part.pm_new_price }}</p>
        </div>
    </div>

    <div class="impact-cards">
        <div class="card">
            <div class="card-header">
                <div class="icon-box blue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M3 7L12 2L21 7V17L12 22L3 17V7Z" stroke="#2F80ED" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h4>Affected Packages</h4>
            </div>

            <h2>{{ part.model_codes?.length }}</h2>
            <p>Service packages impacted</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="icon-box green">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M3 17L9 11L13 15L21 7" stroke="#27AE60" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M14 7H21V14" stroke="#27AE60" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <h4>New Price</h4>
            </div>

            <h2 style="color: #27ae60">AED {{ part.pm_new_price | number : '1.2-2' }}</h2>

            <p>For all Service package</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="icon-box yellow">
                    <!-- UAE AED Icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <text x="2" y="16" font-size="14" font-weight="bold" fill="#F2C94C">ÿØ.ÿ•</text>
                    </svg>
                </div>
                <h4>Old Price</h4>
            </div>

            <h2>AED {{ part.pm_price | number : '1.2-2' }}</h2>
            <!-- <p>Estimated revenue change</p> -->
        </div>

        <div class="card">
            <div class="card-header">
                <div class="icon-box yellow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M3 17L9 11L13 15L21 7" stroke="#F2C94C" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M14 7H21V14" stroke="#F2C94C" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <h4>Price Difference</h4>
            </div>

            <h2>
                <span [class.text-green-600]="priceDiff > 0" [class.text-red-600]="priceDiff < 0"> AED {{ priceDiff |
                    number : '1.2-2' }} </span>
            </h2>
        </div>
    </div>

    <!-- Threshold Section -->
    <div class="threshold-card mt-2 rounded-xl border border-gray-200 bg-white p-4 shadow">
        <h3 class="mb-3 text-lg font-semibold text-gray-800">Set Threshold for Price Rounding</h3>

        <p class="mb-4 text-sm text-gray-600">
            <strong>Threshold</strong> is the rounding step applied to the <em>new display price</em> after adding the
            price difference. The result is rounded
            to the nearest multiple of this threshold.
        </p>

        <!-- Examples -->
        <div class="mb-5 grid grid-cols-1 gap-4 md:grid-cols-2" *ngIf="getThresholdExamples() as example">
            <!-- ================= Example 1 ================= -->
            <div class="rounded-lg border bg-gray-50 p-4 text-sm">
                <p class="mb-3 font-semibold">Example 1 (Threshold = 0 ‚Äî No Rounding)</p>

                <div class="mb-3 text-gray-700">
                    <strong>{{ example.model.spmc_value }}</strong> |
                    <strong>{{ example.km.km_id == 1 ? 'Quick Lube' : example.km.km_value / 1000 + 'K km' }}</strong>
                    |<strong>QTY: {{ example.model.sp_spare_qty }}</strong>
                </div>

                <div class="grid grid-cols-2 gap-y-1">
                    <div>Original Display</div>
                    <div class="text-right font-semibold">AED {{ example.originalDisplay | number : '1.2-2' }}</div>

                    <div>Price Difference (per unit)</div>
                    <div class="text-right font-semibold">AED {{ example.difference | number : '1.2-2' }}</div>

                    <div class="pt-2">Raw New Display</div>
                    <div class="pt-2 text-right font-semibold">AED {{ example.rawNewPrice | number : '1.2-2' }}</div>

                    <div>Rounded Display</div>
                    <div class="text-right font-semibold">AED {{ example.rawNewPrice | number : '1.2-2' }}</div>

                    <div>Adjustment</div>
                    <div class="text-right font-semibold">AED 0.00</div>
                </div>
            </div>

            <!-- ================= Example 2 ================= -->
            <div class="rounded-lg border bg-gray-50 p-4 text-sm">
                <p class="mb-3 font-semibold">Example 2 (Threshold = {{ example.previewThreshold }})</p>

                <div class="mb-3 text-gray-700">
                    <strong>{{ example.model.spmc_value }}</strong> |
                    <strong>{{ example.km.km_id == 1 ? 'Quick Lube' : example.km.km_value / 1000 + 'K km' }}</strong>
                    |<strong> QTY: {{ example.model.sp_spare_qty }}</strong>
                </div>

                <div class="grid grid-cols-2 gap-y-1">
                    <div>Original Display</div>
                    <div class="text-right font-semibold">AED {{ example.originalDisplay | number : '1.2-2' }}</div>

                    <div>Price Difference (per unit)</div>
                    <div class="text-right font-semibold">AED {{ example.difference | number : '1.2-2' }}</div>

                    <div class="pt-2">Raw New Display</div>
                    <div class="pt-2 text-right font-semibold">AED {{ example.rawNewPrice | number : '1.2-2' }}</div>

                    <div>Rounded Display</div>
                    <div class="text-right font-semibold">AED {{ example.roundedPreview | number : '1.2-2' }}</div>

                    <div>Adjustment</div>
                    <div class="text-right font-semibold" [class.text-green-600]="example.adjustment > 0"
                        [class.text-red-600]="example.adjustment < 0">
                        AED {{ example.adjustment | number : '1.2-2' }}
                    </div>

                    <div class="pt-2">Final Markup</div>
                    <div class="pt-2 text-right font-semibold">AED {{ example.km.original_markup_price +
                        example.adjustment | number : '1.2-2' }}</div>
                </div>
            </div>
        </div>

        <!-- Threshold Selection -->
        <div class="flex items-center gap-4">
            <label class="text-sm font-medium">Select Threshold:</label>

            <ng-select [items]="[0, 5, 10]" [(ngModel)]="selectedThreshold" (change)="recalculateWithThreshold()"
                [clearable]="false" class="w-40"> </ng-select>

            <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700"
                (click)="recalculateWithThreshold()" [disabled]="!selectedThreshold || buttonFlag">
                Apply
            </button>
        </div>

        <p class="mt-4 text-sm text-red-600">
            <strong>Note:</strong> Updating this part's price will also update the display price in all Service Packages
            that use it.
        </p>
    </div>

    <div class="table-card">
        <div class="mb-4 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold tracking-wide text-gray-800">Affected Models & Kilometer-Based Pricing
                </h3>
                <p class="text-sm text-gray-500">Expand models to view and select kilometer-based pricing slabs.</p>
            </div>

            <div class="flex items-center gap-3">
                <button type="button"
                    class="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 disabled:bg-gray-400"
                    (click)="confirmCancelPrice()">
                    Decline
                </button>

                <button type="button"
                    class="rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700 disabled:bg-gray-400"
                    [disabled]="selectedKms.length === 0 || buttonFlag" (click)="updateSelectedPrices()">
                    Update Selected Prices
                </button>
            </div>
        </div>
        <div class="mb-4 flex gap-6 text-sm font-medium">
            <span>{{ part.model_codes.length }} Models Affected</span>
            <span [ngClass]="selectedModelCodes.length > 0 ? 'text-blue-600' : 'text-gray-400'"> {{
                selectedModelCodes.length }} Models Selected </span>
        </div>

        <div *ngIf="hasAnyMarkupIssue()"
            class="mb-4 flex items-start gap-2 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700">
            <span class="font-semibold">‚ö† Pricing Notice:</span>

            After applying the selected threshold, the markup for one or more models has been reduced to
            <strong>0</strong>. Please review the highlighted models before proceeding with the price update.
        </div>

        <!-- <div class="mb-4 flex justify-between items-center">
            <div class="relative w-80">
                <input type="text" [(ngModel)]="searchTerm" placeholder="Search by Model Code or VIN..."
                    class="w-full px-4 py-2 pl-10 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />

                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    üîç
                </span>
            </div>
        </div> -->

        <div class="relative">
            <div class="overflow-visible">
                <table>
                    <thead class="sticky top-0 z-10 bg-gray-50">
                        <tr>
                            <th class="border-b px-4 py-3">
                                <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll($event)"
                                    class="h-4 w-4" />
                            </th>

                            <th class="border-b px-6 py-3 text-left text-xs uppercase text-gray-500">Model Code</th>

                            <th class="border-b px-6 py-3 text-right text-xs uppercase text-gray-500">Vin NO</th>

                            <th class="border-b px-6 py-3 text-center text-xs uppercase text-gray-500">Qty</th>

                            <th class="border-b px-6 py-3 text-right text-xs uppercase text-gray-500">Model Year</th>

                            <th class="border-b px-6 py-3 text-right text-xs uppercase text-gray-500">Variant Name</th>

                            <th class="border-b px-6 py-3 text-right text-xs uppercase text-gray-500">Package Type</th>

                            <th class="border-b px-4 py-3"></th>
                        </tr>
                    </thead>

                    <tbody>
                        <ng-container *ngFor="let model of part.model_codes; let i = index; trackBy: trackByModel">
                            <!-- Main Row -->
                            <tr class="border-b transition-colors" [ngClass]="
                                    model.hasMarkupIssue
                                        ? 'border-l-4 border-red-500 bg-red-50/40'
                                        : selectedModelCodes.includes(model.modelCode)
                                        ? 'border-l-4 border-blue-500 bg-blue-50'
                                        : 'hover:bg-gray-50'
                                ">
                                <td class="px-4 py-4">
                                    <input type="checkbox" [checked]="selectedModelCodes.includes(model.modelCode)"
                                        (change)="toggleModelSelection(model, $event)" class="h-4 w-4" />
                                </td>

                                <td class="px-6 py-4 text-sm font-bold tracking-wide"
                                    [ngClass]="model.hasMarkupIssue ? 'text-red-700' : 'text-blue-800'">
                                    {{ model.spmc_value }}
                                </td>

                                <td class="px-6 py-4 font-bold">
                                    {{ model.spmc_vin_no }}
                                </td>

                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center rounded-md px-3 py-1 text-xs font-semibold"
                                        [ngClass]="
                                            model.sp_spare_qty >= 8
                                                ? 'bg-red-100 text-red-700'
                                                : model.sp_spare_qty >= 5
                                                ? 'bg-orange-100 text-orange-700'
                                                : 'bg-blue-50 text-blue-300'
                                        ">
                                        {{ model.sp_spare_qty }}
                                    </span>
                                </td>

                                <td class="px-6 py-4 font-bold">
                                    {{ model.spmc_model_year }}
                                </td>

                                <td class="px-6 py-4 font-bold">
                                    {{ model.spmc_variant }}
                                </td>

                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"
                                        [ngClass]="model.spmc_type == 0 ? 'bg-green-100 text-green-500' : 'bg-blue-100 text-blue-500'">
                                        {{ model.spmc_type == 0 ? 'Normal Service Package' : 'Facelift Service Package'
                                        }}
                                    </span>
                                </td>

                                <td class="px-4 py-4 text-center">
                                    <button (click)="toggleRow(i)" type="button"
                                        class="cursor-pointer rounded-lg px-3 py-2 text-xs font-semibold shadow-sm transition-all duration-200 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-1 active:scale-95 active:shadow-sm"
                                        [ngClass]="
                                            expandedRows.includes(i)
                                                ? 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-400'
                                                : 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-400'
                                        ">
                                        {{ expandedRows.includes(i) ? 'Hide Pricing' : 'View Pricing' }}
                                    </button>
                                </td>
                            </tr>

                            <tr *ngIf="expandedRows.includes(i)" class="border-t bg-gray-50">
                                <td colspan="8" class="relative p-4">
                                    <div class="mb-4 rounded-2xl border border-gray-200 bg-white p-4 shadow-lg">
                                        <div class="mb-2 h-1 rounded-t-xl bg-blue-500"></div>
                                        <div *ngIf="model.hasMarkupIssue"
                                            class="mb-3 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700">
                                            <strong>Warning:</strong> Markup became zero for:

                                            <span class="font-semibold">
                                                {{ getProblematicKilometers(model) }}
                                            </span>
                                        </div>

                                        <div class="flex flex-col items-start gap-4 lg:flex-row">
                                            <div class="w-full md:w-1/3">
                                                <label class="mb-2 block text-xs font-semibold uppercase text-gray-500">
                                                    Select Kilometer Slab </label>

                                                <ng-container *ngIf="model.kms?.length > 0; else noKm">
                                                    <ng-select [items]="model.kms" bindLabel="km_value"
                                                        [clearable]="false" [searchable]="false" dropdownPosition="auto"
                                                        [(ngModel)]="model.selectedKm"
                                                        class="custom-multiselect w-full">
                                                        <ng-template ng-label-tmp let-item="item">
                                                            {{ item.km_id == 1 ? 'Quick Lube' : item.km_value / 1000 +
                                                            'K km' }}
                                                        </ng-template>

                                                        <ng-template ng-option-tmp let-item="item">
                                                            {{ item.km_id == 1 ? 'Quick Lube' : item.km_value / 1000 +
                                                            'K km' }}
                                                        </ng-template>
                                                    </ng-select>
                                                </ng-container>

                                                <!-- Fallback message when kms array empty -->
                                                <ng-template #noKm>
                                                    <div
                                                        class="mt-2 rounded border border-dashed border-gray-200 bg-gray-50 p-3 text-sm text-gray-600">
                                                        There is no kilometer slab selected for this model code for this
                                                        part.
                                                    </div>
                                                </ng-template>
                                            </div>

                                            <!-- Right: pricing table (responsive) -->
                                            <div class="mt-4 w-full md:mt-0 md:w-2/3">
                                                <table class="w-full overflow-hidden rounded-xl border border-gray-100">
                                                    <thead
                                                        class="bg-gray-100 text-xs font-semibold uppercase text-blue-800">
                                                        <tr>
                                                            <th class="px-4 py-2 text-left">Kilometer</th>
                                                            <th class="px-4 py-2 text-right">Markup Price</th>
                                                            <th class="px-4 py-2 text-right">New Markup</th>
                                                            <th class="px-4 py-2 text-right">Display Price</th>
                                                            <th class="px-4 py-2 text-right">New Display</th>
                                                        </tr>
                                                    </thead>

                                                    <!-- show table only when a km is selected -->
                                                    <tbody *ngIf="model.selectedKm; else selectHint">
                                                        <tr class="border-t">
                                                            <td class="px-4 py-2 font-semibold">
                                                                {{ model.selectedKm?.km_id == 1 ? 'Quick Lube' :
                                                                model.selectedKm?.km_value / 1000 + 'K km' }}
                                                            </td>

                                                            <!-- Old Markup -->
                                                            <td class="px-4 py-2 text-right font-semibold">
                                                                AED {{ model.selectedKm.markup_price | number : '1.2-2'
                                                                }}
                                                            </td>

                                                            <!-- New Markup -->
                                                            <td class="px-4 py-2 text-right"
                                                                [class.text-green-600]="model.selectedKm.new_markup_price > model.selectedKm.markup_price"
                                                                [class.text-red-600]="model.selectedKm.new_markup_price < model.selectedKm.markup_price"
                                                                [class.font-bold]="model.selectedKm.new_markup_price !== model.selectedKm.markup_price">
                                                                AED {{ model.selectedKm.new_markup_price | number :
                                                                '1.2-2' }}
                                                            </td>

                                                            <!-- Old Display -->
                                                            <td class="px-4 py-2 text-right font-semibold">
                                                                AED {{ model.selectedKm.display_price | number : '1.2-2'
                                                                }}
                                                            </td>

                                                            <!-- New Display -->
                                                            <td class="px-4 py-2 text-right"
                                                                [class.text-green-600]="model.selectedKm.new_display_price > model.selectedKm.display_price"
                                                                [class.text-red-600]="model.selectedKm.new_display_price < model.selectedKm.display_price"
                                                                class="font-bold">
                                                                AED {{ model.selectedKm.new_display_price | number :
                                                                '1.2-2' }}
                                                            </td>
                                                        </tr>
                                                    </tbody>

                                                    <!-- Hint shown when kms exist but user hasn't picked a slab -->
                                                    <ng-template #selectHint>
                                                        <tbody>
                                                            <tr>
                                                                <td colspan="5"
                                                                    class="px-4 py-6 text-center text-sm text-gray-500">
                                                                    Please select a kilometer slab to view pricing for
                                                                    this model.
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </ng-template>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>