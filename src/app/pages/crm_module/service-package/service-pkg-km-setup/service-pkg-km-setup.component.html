<ol class="flex font-semibold text-primary dark:text-white-dark">
    <li class="bg-[#ebedf2] ltr:rounded-l-md rtl:rounded-r-md dark:bg-[#1b2e4b]">
        <a
            routerLink="/dashboard"
            class="relative flex h-full items-center p-1.5 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-3 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-3 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70"
            >Home</a
        >
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180"
        >
            Service Management</a
        >
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            routerLink="/servicePackageRequested"
            class="relative flex h-full items-center p-1.5 px-3 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-6 ltr:before:-right-[15px] rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70"
        >
            Service Package Requested</a
        >
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180"
        >
            Service Package</a
        >
    </li>
</ol>

<div *ngIf="load_flag" style="text-align: center">
    <span
        class="m-auto mb-10 inline-block h-14 w-14 animate-[spin_3s_linear_infinite] rounded-full border-8 border-b-success border-l-primary border-r-warning border-t-danger align-middle"
    ></span>
</div>

<div class="panel mb-5 mt-5 pb-5" *ngIf="!load_flag">
    <div class="grid grid-cols-3 items-end gap-4 sm:grid-cols-3">
        <div>
            <label>Model Code</label>
            <input [(ngModel)]="model_code" type="text" placeholder="Model Number" class="form-input text-xs" maxlength="5" [disabled]="true" />
        </div>
        <div>
            <label>Vin No</label>
            <input [(ngModel)]="vin_no" type="text" placeholder="Model Number" class="form-input text-xs" maxlength="20" [disabled]="true" />
        </div>
        <div>
            <label>Variant</label>
            <input [(ngModel)]="variant" type="text" placeholder="Model Number" class="form-input text-xs" maxlength="50" [disabled]="true" />
        </div>
        <div>
            <label>Model Year</label>
            <input [(ngModel)]="model_year" type="text" placeholder="Model Number" class="form-input text-xs" maxlength="20" [disabled]="true" />
        </div>
        <div>
            <label>Engine No</label>
            <ng-select
                fullWidth
                [items]="engines"
                bindLabel="eng_no"
                [multiple]="false"
                [(ngModel)]="engineNO"
                bindValue="eng_id"
                [searchable]="true"
                [clearable]="false"
                placeholder="Select Engine Numbers"
                class="custom-multiselect"
                [disabled]="true"
            >
            </ng-select>
        </div>
    </div>
    <hr class="my-6 border-[#e0e6ed] dark:border-[#1b2e4b]" />
    <div class="mb-2 p-4" *ngIf="spareAndLabourList?.items?.length > 0">
        <div class="flex flex-row items-center justify-end gap-6">
            <!-- Km Check -->
            <label class="flex cursor-not-allowed items-center gap-2">
                <div class="flex h-5 w-5 items-center justify-center rounded bg-blue-500 text-white shadow-sm">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <span class="text-sm font-semibold text-gray-700">Km Check</span>
            </label>

            <!-- Optional Flag -->
            <label class="flex cursor-not-allowed items-center gap-2">
                <div class="flex h-5 w-5 items-center justify-center rounded bg-green-500 text-black shadow-sm">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <span class="text-sm font-semibold text-gray-700">Optional Flag</span>
            </label>
        </div>
        <div class="table-wrapper max-h-[500px] overflow-y-auto">
            <div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th class="sticky top-0 z-10 bg-white">Items</th>
                            <th class="sticky top-0 z-10 bg-white">Price</th>
                            <th *ngFor="let km of kilometers" style="text-align: right" class="sticky top-0 z-10 bg-white">{{ km.label }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of spareAndLabourList.items">
                            <td class="whitespace-nowrap">
                                {{ data.name }}
                                <div style="display: flex; flex-direction: column; align-items: flex-end">
                                    <ng-container>
                                        <label style="font-weight: normal; display: flex; align-items: center; gap: 4px; margin-top: 2px">
                                            Check All
                                            <input
                                                type="checkbox"
                                                [checked]="isAllKmChecked(data)"
                                                class="form-checkbox h-4 w-4"
                                                title="Check All"
                                                ngxTippy="Check All"
                                                (change)="toggleAllKmsForItem(data, $event)"
                                            />
                                        </label>
                                    </ng-container>
                                </div>
                            </td>
                            <td style="text-align: right">{{ data.price | number : '1.2-2' }}</td>
                            <td *ngFor="let km of kilometers" style="text-align: right">
                                <div class="flex flex-col items-center gap-1">
                                    <input
                                        type="checkbox"
                                        class="h-4 w-4 rounded-full border-2 border-blue-500 accent-blue-500 shadow-sm"
                                        [checked]="data.selectedKmIds?.includes(km.km_id)"
                                        (change)="onKmCheckboxChange(data, km.km_id, $event)"
                                        title="System"
                                    />
                                    <input
                                        type="checkbox"
                                        class="h-4 w-4 border-2 border-green-600 bg-green-100 accent-green-500"
                                        [checked]="data.customerSelectedKmIds?.includes(km.km_id)"
                                        (change)="onCustomerKmCheckboxChange(data, km, $event)"
                                        [disabled]="!km.columnAllowed || !data.selectedKmIds?.includes(km.km_id)"
                                    />

                                    <!-- <input type="checkbox"
                                        class="h-4 w-4 rounded-full border-2 border-blue-500 accent-blue-500 shadow-sm"
                                        [checked]="data.selectedKmIds?.includes(km.km_id)"
                                        (change)="onKmCheckboxChange(data, km.km_id, $event)" />

                                    <input type="checkbox"
                                        class="h-5 w-5 border-2 border-green-600 bg-green-100 accent-green-500"
                                        [checked]="data.customerSelectedKmIds?.includes(km.km_id)"
                                        (change)="onCustomerKmCheckboxChange(data, km.km_id, $event)"
                                        [disabled]="!km.columnAllowed || !data.selectedKmIds?.includes(km.km_id)" /> -->
                                </div>
                            </td>
                        </tr>
                        <!-- <tr>
                        <td colspan="3" style="text-align: right;"><strong>TOTAL PRICE</strong></td>
                        <td *ngFor="let km of kilometers" style="text-align: right;">
                            <strong>{{ getTotalPriceForKm(km.km_id) | number: '1.2-2' }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: right;"><strong>DISPLAY PRICE</strong></td>
                        <td *ngFor="let km of kilometers" style="text-align: right;">
                            <input type="number" [(ngModel)]="km.display_price" (change)="onDisplayPriceChange(km)"
                                class="form-input w-20 text-right" placeholder="0.00" />
                        </td>
                    </tr> -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-6 flex justify-end">
        <div class="flex items-center gap-2">
            <button
                type="button"
                class="btn btn-secondary flex items-center gap-2"
                (click)="saveServicePackageKm(1)"
                [disabled]="saveFlag || draftButtonFlag"
                *ngIf="spStatus != 5"
            >
                <span *ngIf="!draftButtonFlag"> Save As Draft</span>
                <span *ngIf="draftButtonFlag">Saving...</span>
                <span *ngIf="draftButtonFlag" class="loader h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            </button>
            <button type="button" class="btn btn-primary" (click)="saveServicePackageKm(0)" [disabled]="saveFlag">
                <span *ngIf="!saveFlag"
                    >Proceed To KM Pricing
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="ml-1 inline-block">
                        <path d="M4 12H20M20 12L14 6M20 12L14 18" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
                <span *ngIf="saveFlag">Saving...</span>
                <span *ngIf="saveFlag" class="loader h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            </button>
        </div>
    </div>
</div>
<modal #KmMappingModal class="modal-top animate animate-slide-in-down extra-large-modal call-view" [closeOnOutsideClick]="false" style="max-width: 90vw">
    <ng-template #modalHeader>
        <div style="align-items: center; display: flex">Km Mapping List</div>
    </ng-template>
    <ng-template #modalBody>
        <h2 class="text-center text-2xl">
            The Km Mapping for Engine No. <b>{{ currentEngineNo }}</b> are already listed below. <br />
            Would you like to copy those Km Mapping for this one?
        </h2>

        <table class="mt-4 w-full table-auto border border-gray-300 text-sm">
            <thead class="bg-gray-100 text-left">
                <tr>
                    <th class="border px-4 py-2">Engine No</th>
                    <th class="border px-4 py-2">Model Code</th>
                    <th class="border px-4 py-2">Action</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let part of finalItems">
                    <td class="border px-4 py-2">{{ currentEngineNo }}</td>
                    <td class="border px-4 py-2">{{ part.modelcode }}</td>
                    <td class="border px-4 py-2">
                        <button type="button" class="btn btn-primary text-white" (click)="copyKmMappingServiceDetails(part)">Copy</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </ng-template>

    <ng-template #modalFooter>
        <button type="button" class="btn btn-danger text-white" (click)="this.KmMappingModal.close()">Dismiss</button>
    </ng-template>
</modal>
