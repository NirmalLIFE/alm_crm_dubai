<ol class="flex font-semibold text-primary dark:text-white-dark">
    <li class="bg-[#ebedf2] ltr:rounded-l-md rtl:rounded-r-md dark:bg-[#1b2e4b]">
        <a routerLink="/dashboard"
            class="relative flex h-full items-center p-1.5 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-3 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-3 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70">Home</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180">
            Periodic Service</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a routerLink="/servicePackageRequested"
            class="relative flex h-full items-center p-1.5 px-3 before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-[#ebedf2] before:border-t-transparent hover:text-primary/70 ltr:pl-6 ltr:before:-right-[15px] rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180 dark:before:border-l-[#1b2e4b] dark:hover:text-white-dark/70">
            Service Package Requested</a>
    </li>
    <li class="bg-[#ebedf2] dark:bg-[#1b2e4b]">
        <a
            class="relative flex h-full items-center bg-primary p-1.5 text-white-light before:absolute before:inset-y-0 before:z-[1] before:m-auto before:h-0 before:w-0 before:border-[16px] before:border-l-[15px] before:border-r-0 before:border-b-transparent before:border-l-primary before:border-t-transparent ltr:pl-6 ltr:pr-2 ltr:before:-right-[15px] rtl:pl-2 rtl:pr-6 rtl:before:-left-[15px] rtl:before:rotate-180">
            Service Package KM Price Map</a>
    </li>
</ol>

<div *ngIf="load_flag" style="text-align: center">
    <span
        class="m-auto mb-10 inline-block h-14 w-14 animate-[spin_3s_linear_infinite] rounded-full border-8 border-b-success border-l-primary border-r-warning border-t-danger align-middle"></span>
</div>

<div class="panel mb-5 mt-5 pb-5" *ngIf="!load_flag">
    <div class="grid grid-cols-3 items-end gap-4 sm:grid-cols-3">
        <div>
            <label>Model Code</label>
            <input [(ngModel)]="model_code" type="text" placeholder="Model Number" class="form-input text-xs"
                maxlength="5" [disabled]="true" />
        </div>
        <div>
            <label>Vin No</label>
            <input [(ngModel)]="vin_no" type="text" placeholder="Model Number" class="form-input text-xs" maxlength="20"
                [disabled]="true" />
        </div>
        <div>
            <label>Variant</label>
            <input [(ngModel)]="variant" type="text" placeholder="Model Number" class="form-input text-xs"
                maxlength="50" [disabled]="true" />
        </div>
        <div>
            <label>Model Year</label>
            <input [(ngModel)]="model_year" type="text" placeholder="Model Number" class="form-input text-xs"
                maxlength="20" [disabled]="true" />
        </div>
        <div>
            <label>Engine No </label>
            <ng-select fullWidth [items]="engines" bindLabel="eng_no" [multiple]="false" [(ngModel)]="engineNO"
                bindValue="eng_id" [searchable]="true" [clearable]="false" placeholder="Select Engine Numbers"
                class="custom-multiselect" [disabled]="true">
            </ng-select>
        </div>

        <!-- Facelift badge outside all input divs, aligned right -->
        <div *ngIf="requestedServicePackage.spmc_type == '1'" class="mt-8 flex justify-end">
            <div
                class="inline-block px-4 py-1 rounded-full bg-gradient-to-r from-blue-700 to-blue-500 text-white font-semibold shadow-md text-sm">
                Facelift Service Package
            </div>
        </div>
    </div>
    <hr class="my-6 border-[#e0e6ed] dark:border-[#1b2e4b]" />
    <div class="mb-2 p-4" *ngIf="spareAndLabourList?.items?.length > 0">
        <div class="flex flex-row items-center justify-end gap-6">
            <!-- Km Check -->
            <label class="flex cursor-not-allowed items-center gap-2">
                <div class="flex h-5 w-5 items-center justify-center rounded bg-blue-500 text-white shadow-sm">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <span class="text-sm font-semibold text-gray-700">Km Check</span>
            </label>

            <!-- Optional Flag -->
            <label class="flex cursor-not-allowed items-center gap-2">
                <div class="flex h-5 w-5 items-center justify-center rounded bg-green-500 text-black shadow-sm">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <span class="text-sm font-semibold text-gray-700">Optional Flag</span>
            </label>

            <!-- Back button row -->
            <div class="mb-3 flex items-center justify-end">
                <button class="btn rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
                    (click)="goBack()">Back</button>
            </div>
        </div>
        <div #scrollContainer class="table-responsive max-h-[520px] overflow-y-auto">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th class="sticky top-0 z-20 bg-white font-bold" [style.text-align]="'left'">Parts & Labours
                        </th>
                        <th class="sticky top-0 z-20 bg-white font-bold">Price</th>
                        <th *ngFor="let km of selectedKilometers"
                            class="sticky top-0 z-20 min-w-[80px] bg-white px-3 py-2 font-bold"
                            [style.text-align]="'right'">
                            {{ km.label }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of spareAndLabourList.items">
                        <td class="whitespace-nowrap">{{ data.name }}</td>
                        <td style="padding-left: 0.1px; padding-right: 0.1px" [style.text-align]="'right'">{{ data.price
                            | number : '1.2-2' }}</td>
                        <td *ngFor="let km of selectedKilometers"
                            class="min-w-[80px] bg-white px-3 py-2 text-right font-bold">
                            <div class="flex flex-col items-end gap-1">
                                <div class="flex h-4 w-4 items-center justify-center rounded border-2" [ngClass]="{
                                        'border-blue-500 bg-blue-500 text-white': data.selectedKmIds?.includes(km.km_id),
                                        'border-gray-300 bg-gray-200 text-transparent': !data.selectedKmIds?.includes(km.km_id)
                                    }">
                                    <svg class="h-2.5 w-2.5" fill="none" stroke="currentColor" stroke-width="3"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>

                                <div class="flex h-4 w-4 items-center justify-center rounded border-2" [ngClass]="{
                                        'border-green-500 bg-green-500 text-white': data.optional_kmIds?.includes(km.km_id),
                                        'border-gray-300 bg-gray-200 text-transparent': !data.optional_kmIds?.includes(km.km_id)
                                    }">
                                    <svg class="h-2.5 w-2.5" fill="none" stroke="currentColor" stroke-width="3"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right"><strong>Total Price</strong></td>
                        <td *ngFor="let km of selectedKilometers" class="w-27 h-8 text-right text-xs"
                            [style.text-align]="'right'">
                            <strong>{{ getTotalPriceForKm(km.km_id) | number : '1.2-2' }}</strong>
                        </td>
                    </tr>
                    <!-- Variable prices calculation -->
                    <tr>
                        <td colspan="2" style="text-align: right; vertical-align: top">
                            <div style="display: flex; flex-direction: column; align-items: flex-end">
                                <strong>Variable Price</strong>

                                <ng-container *ngIf="hasAnyVariablePrice()">
                                    <label
                                        style="font-weight: normal; display: flex; align-items: center; gap: 4px; margin-top: 2px">
                                        Check All
                                        <input type="checkbox" [checked]="allChecked"
                                            (change)="toggleAllVariableChecks($event)" class="form-checkbox h-4 w-4"
                                            title="Check All" ngxTippy="Check All" />
                                    </label>
                                </ng-container>
                            </div>
                        </td>

                        <td *ngFor="let km of selectedKilometers; let i = index" class="w-27 h-8 text-right text-xs"
                            style="text-align: right">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 4px">
                                <strong [style.color]="km.variable_price < 0 ? 'red' : 'inherit'">
                                    {{ km.variable_price | number : '1.2-2' }}
                                </strong>

                                <!-- Individual Checkbox -->
                                <input *ngIf="km.variable_price" type="checkbox" [(ngModel)]="km.variable_checked"
                                    (change)="onVariableCheckboxChange(km)" class="form-checkbox h-4 w-4" />
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2" style="text-align: right"><strong>Markup Price</strong></td>
                        <td *ngFor="let km of selectedKilometers" style="padding-left: 2.05px; padding-right: 2.05px"
                            [style.text-align]="'left'">
                            <input type="number" [(ngModel)]="km.markup_price"
                                (ngModelChange)="onDisplayPriceChange(km, 'markup')"
                                class="form-input h-8 w-28 text-right text-xs" placeholder="0.00"
                                onwheel="this.blur()" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right"><strong>Display Price</strong></td>
                        <td *ngFor="let km of selectedKilometers" style="padding-left: 2.05px; padding-right: 2.05px"
                            [style.text-align]="'left'">
                            <input type="number" [(ngModel)]="km.display_price"
                                (ngModelChange)="onDisplayPriceChange(km, 'display')"
                                class="form-input h-8 w-28 text-right text-xs" placeholder="0.00"
                                onwheel="this.blur()" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- <div class="mb-2 p-4" *ngIf="spareAndLabourList?.items?.length > 0">
        <div class="table-responsive max-h-[500px] overflow-y-auto">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th class="sticky top-0 z-20 bg-white">Parts & Labours</th>
                        <th class="sticky top-0 z-20 bg-white">Price</th>
                        <th *ngFor="let km of selectedKilometers" style="text-align: right" class="sticky top-0 z-20 bg-white">{{ km.label }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of spareAndLabourList.items">
                        <td class="whitespace-nowrap">{{ data.name }}</td>
                        <td style="text-align: right">{{ data.price | number : '1.2-2' }}</td>
                        <td *ngFor="let km of selectedKilometers" style="place-items: end">
                            <div
                                class="flex h-5 w-5 items-center justify-center rounded border-2 mb-2"
                                [ngClass]="{
                                    'border-blue-500 bg-blue-500 text-white': data.selectedKmIds?.includes(km.km_id),
                                    'border-gray-300 bg-gray-200 text-transparent': !data.selectedKmIds?.includes(km.km_id)
                                }"
                            >
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>

                            <div
                                class="flex h-5 w-5 items-center justify-center rounded border-2"
                                [ngClass]="{
                                    'border-green-500 bg-green-500 text-white': data.optional_kmIds?.includes(km.km_id),
                                    'border-gray-300 bg-gray-200 text-transparent': !data.optional_kmIds?.includes(km.km_id)
                                }"
                            >
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right"><strong>TOTAL PRICE</strong></td>
                        <td *ngFor="let km of selectedKilometers" style="text-align: right">
                            <strong>{{ getTotalPriceForKm(km.km_id) | number : '1.2-2' }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right"><strong>MARKUP PRICE</strong></td>
                        <td *ngFor="let km of selectedKilometers" style="text-align: right">
                            <input
                                type="number"
                                [(ngModel)]="km.markup_price"
                                (ngModelChange)="onDisplayPriceChange(km, 'markup')"
                                class="form-input w-20 text-right"
                                placeholder="0.00"
                            />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right"><strong>DISPLAY PRICE</strong></td>
                        <td *ngFor="let km of selectedKilometers" style="text-align: right">
                            <input
                                type="number"
                                [(ngModel)]="km.display_price"
                                (ngModelChange)="onDisplayPriceChange(km, 'display')"
                                class="form-input w-20 text-right"
                                placeholder="0.00"
                            />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div> -->

    <div class="mt-6 flex justify-end">
        <button type="button" class="btn btn-primary" (click)="saveServicePackageKmPriceMap()" [disabled]="saveFlag">
            <span *ngIf="!saveFlag">SAVE</span>
            <span *ngIf="saveFlag">Saving...</span>
            <span *ngIf="saveFlag"
                class="loader h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
        </button>
    </div>
</div>

<modal #copyPriceModal class="modal-top animate animate-slide-in-down extra-large-modal call-view"
    [closeOnOutsideClick]="false" style="max-width: 90vw">
    <ng-template #modalHeader>
        <div style="align-items: center; display: flex">Price List</div>
    </ng-template>
    <ng-template #modalBody>
        <div style="max-height: 70vh; overflow-y: auto">
            <h3 class="text-center text-2xl">
                The corresponding <b>Display Price</b> and <b>Markup Price</b> for the same items are shown under the
                respective Model Codes. <br />
                Do you want to copy these prices for Engine No. <b>{{ getSelectedEngineNo() }}</b> and Model Code <b>{{
                    model_code
                    }}</b>?
            </h3>

            <table class="mt-4 w-full table-auto border border-gray-300 text-sm">
                <thead class="bg-gray-100 text-left">
                    <tr>
                        <th class="border px-4 py-2">Engine No</th>
                        <th class="border px-4 py-2">Model Code</th>
                        <th class="border px-4 py-2">Model Year</th>
                        <!-- <th class="border px-4 py-2">Price (AED)</th>
                    <th class="border px-4 py-2">Total Labour Unit</th> -->
                        <th class="border px-4 py-2">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let part of enginePartsList">
                        <td class="border px-4 py-2">{{ getSelectedEngineNo() }}</td>
                        <td class="border px-4 py-2">{{ part.model_code }}</td>
                        <td class="border px-4 py-2">{{ part.spmc_model_year }}</td>
                        <!-- <td class="border px-4 py-2">{{ part.totalConsumablesPrice | number : '1.2-2' }}</td>
                    <td class="border px-4 py-2">{{ part.totalLabourUnit }}</td> -->
                        <td class="border px-4 py-2">
                            <button type="button" (click)="copyPricetoKm(part)"
                                class="btn btn-primary text-white">Copy</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-template>

    <ng-template #modalFooter>
        <button type="button" class="btn btn-danger text-white" (click)="this.copyPriceModal.close()">Dismiss</button>
    </ng-template>
</modal>